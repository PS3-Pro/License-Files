name: Auto Sync & Release PKG

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      PYTHONUTF8: 1

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install pandas requests

      - name: Run Sync Script
        run: python .github/scripts/sync_licenses.py

      - name: Check for Modifications
        id: git-check
        shell: pwsh
        run: |
          git add files/ rap.bin stats.txt
          $status = git status --porcelain
          if ($status) { 
            echo "changed=true" >> $env:GITHUB_OUTPUT 
            echo "Changes detected. Starting PKG creation..."
          } else {
            echo "changed=false" >> $env:GITHUB_OUTPUT
            echo "No changes found. Skipping build."
          }

      - name: Generate PKGs and Update Release
        if: steps.git-check.outputs.changed == 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $cfw_dir = "PS3CFW-LICENSES0_00-0000000000000000"
          $cfw_exdata = "$cfw_dir/dev_hdd0/exdata"
          if (Test-Path $cfw_dir) { Remove-Item -Recurse -Force $cfw_dir }
          New-Item -ItemType Directory -Force -Path $cfw_exdata
          Copy-Item "files/*" -Destination $cfw_exdata
          & .github\scripts\make_pkg.exe $cfw_dir
          if (Test-Path "$cfw_dir.pkg") { Rename-Item "$cfw_dir.pkg" "License_Pack.pkg" -Force }

          $hfw_dir = "PS3HFW-LICENSES0_00-0000000000000000"
          $hfw_exdata = "$hfw_dir/dev_hdd0/exdata"
          if (Test-Path $hfw_dir) { Remove-Item -Recurse -Force $hfw_dir }
          New-Item -ItemType Directory -Force -Path $hfw_exdata
          Copy-Item "rap.bin" -Destination $hfw_exdata
          & .github\scripts\make_pkg.exe $hfw_dir
          if (Test-Path "$hfw_dir.pkg") { Rename-Item "$hfw_dir.pkg" "License_Pack_Bin.pkg" -Force }

          $date = Get-Date -Format "MMM dd, yyyy"
          $qty_raw = Get-Content stats.txt
          $qty = ([int]$qty_raw).ToString("N0", [cultureinfo]::GetCultureInfo("de-DE"))
          $bt = "`"

          $notes = @"
License Files for PS3â„¢ Pro.

ðŸ“…Date:
$date

ðŸ“šQuantity:
$qty License files.

â›”Note:
${bt}License_Pack.pkg${bt} is supported on all firmwares. (Slow installation)
${bt}License_Pack_Bin.pkg${bt} is supported only on ${bt}HEN 3.31${bt} or higher and ${bt}Evilnat 4.91.3${bt} or higher, and installs instantly. (Recommended)

ðŸ“ˆStatistics:
[![Github releases](https://img.shields.io/github/downloads/PS3-Pro/License-Files/Licenses/License_Pack.pkg)](https://github.com/PS3-Pro/License-Files/releases/download/Licenses/License_Pack.pkg) [![Github releases](https://img.shields.io/github/downloads/PS3-Pro/License-Files/Licenses/License_Pack_Bin.pkg)](https://github.com/PS3-Pro/License-Files/releases/download/Licenses/License_Pack_Bin.pkg)
"@

          gh release edit Licenses --notes "$notes"
          gh release upload Licenses License_Pack.pkg License_Pack_Bin.pkg --clobber

          git config --local user.email "action@github.com"
          git config --local user.name "PS3-Pro Bot"
          git commit -m "Auto-update: $date ($qty files synced)"
          git push